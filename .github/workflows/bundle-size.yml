name: Bundle Size

on:
  # We use `pull_request_target` to split trust boundaries across jobs:
  # - `benchmark-pr` checks out PR merge code and runs it as untrusted with read-only permissions.
  # - `capture` runs trusted base-repo code, captures metadata, and passes outputs to other trusted jobs.
  # - `comment-pr` runs trusted base-repo code with limited write access to upsert the PR comment.
  pull_request_target:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  benchmark-pr:
    name: Benchmark PR
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Tools
        uses: tanstack/config/.github/setup@main

      - name: Measure Bundle Size
        run: pnpm nx run tanstack-router-e2e-bundle-size:build --outputStyle=stream --skipRemoteCache

      - name: Upload Benchmark Outputs
        uses: actions/upload-artifact@v4
        with:
          name: bundle-size-current-json
          path: e2e/bundle-size/results/current.json
          if-no-files-found: error
          retention-days: 1

  capture:
    name: Capture PR Metadata
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    needs: benchmark-pr
    outputs:
      current_json_b64: ${{ steps.capture.outputs.current_json_b64 }}
      base_sha: ${{ steps.capture.outputs.base_sha }}
      pr_number: ${{ steps.capture.outputs.pr_number }}
    steps:
      - name: Download Benchmark Outputs
        uses: actions/download-artifact@v4
        with:
          name: bundle-size-current-json
          path: e2e/bundle-size/results

      - name: Capture Benchmark Outputs
        id: capture
        run: |
          {
            echo "current_json_b64=$(base64 -w 0 < e2e/bundle-size/results/current.json)"
            echo "base_sha=${{ github.event.pull_request.base.sha }}"
            echo "pr_number=${{ github.event.pull_request.number }}"
          } >> "$GITHUB_OUTPUT"

  comment-pr:
    name: Upsert PR Comment
    if: github.event_name == 'pull_request_target'
    runs-on: ubuntu-latest
    needs: capture
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Restore Benchmark Outputs
        env:
          CURRENT_JSON_B64: ${{ needs.capture.outputs.current_json_b64 }}
        run: |
          mkdir -p e2e/bundle-size/results
          node -e "const fs=require('node:fs'); fs.writeFileSync('e2e/bundle-size/results/current.json', Buffer.from(process.env.CURRENT_JSON_B64 || '', 'base64'))"

      - name: Read Historical Data (if available)
        run: |
          mkdir -p e2e/bundle-size/results
          if git fetch --depth=1 origin gh-pages; then
            if git show origin/gh-pages:benchmarks/bundle-size/data.js > e2e/bundle-size/results/history-data.js 2>/dev/null; then
              echo "Loaded bundle-size history from gh-pages."
            else
              rm -f e2e/bundle-size/results/history-data.js
              echo "No bundle-size history found on gh-pages yet."
            fi
          fi

      - name: Build PR Report
        run: |
          node scripts/benchmarks/bundle-size/pr-report.mjs \
            --current e2e/bundle-size/results/current.json \
            --history e2e/bundle-size/results/history-data.js \
            --output e2e/bundle-size/results/pr-comment.md \
            --base-sha "${{ needs.capture.outputs.base_sha }}" \
            --dashboard-url "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/benchmarks/bundle-size/"

      - name: Upsert Sticky PR Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          node scripts/benchmarks/common/upsert-pr-comment.mjs \
            --pr "${{ needs.capture.outputs.pr_number }}" \
            --body-file e2e/bundle-size/results/pr-comment.md

  benchmark-main:
    name: Publish Bundle Size History
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.repository_owner == 'TanStack'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 0

      - name: Setup Tools
        uses: tanstack/config/.github/setup@main

      - name: Measure Bundle Size
        run: pnpm nx run tanstack-router-e2e-bundle-size:build --outputStyle=stream --skipRemoteCache

      - name: Publish Benchmark Dashboard
        uses: benchmark-action/github-action-benchmark@4bdcce38c94cec68da58d012ac24b7b1155efe8b # v1.20.7
        with:
          tool: customSmallerIsBetter
          name: Bundle Size (gzip)
          output-file-path: e2e/bundle-size/results/benchmark-action.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: true
          gh-pages-branch: gh-pages
          benchmark-data-dir-path: benchmarks/bundle-size
          max-items-in-chart: 200
          summary-always: true
          comment-on-alert: false
          fail-on-alert: false
