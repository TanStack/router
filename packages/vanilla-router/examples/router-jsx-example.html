<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vanilla Router + JSX</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    nav {
      background: white;
      border-bottom: 1px solid #e0e0e0;
      padding: 1rem 2rem;
      display: flex;
      gap: 1rem;
    }
    nav a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }
    nav a:hover {
      text-decoration: underline;
    }
    main {
      padding: 2rem;
      max-width: 800px;
      margin: 0 auto;
    }
    .post-list {
      list-style: none;
      padding: 0;
    }
    .post-item {
      padding: 1rem;
      margin-bottom: 0.5rem;
      background: white;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .post-item a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }
    .post-item a:hover {
      text-decoration: underline;
    }
    .post-detail {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    .post-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .post-body {
      line-height: 1.6;
      color: #666;
    }
    .loading {
      padding: 2rem;
      text-align: center;
      color: #999;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // Import router and renderer
    const { 
      createRouter, 
      createRootRoute, 
      createRoute,
      buildHref,
      outlet,
      vanillaRouter
    } = await import('../../dist/index.js')
    
    const { VanillaRenderer, jsx } = await import('../renderer/renderer.ts')

    // Mock data fetching
    async function fetchPosts() {
      await new Promise(resolve => setTimeout(resolve, 500))
      return [
        { id: '1', title: 'Getting Started with Vanilla Router' },
        { id: '2', title: 'JSX Rendering Made Simple' },
        { id: '3', title: 'Building Modern Web Apps' },
      ]
    }

    async function fetchPost(id) {
      await new Promise(resolve => setTimeout(resolve, 300))
      const posts = {
        '1': { title: 'Getting Started with Vanilla Router', body: 'Vanilla Router is a powerful routing solution for vanilla JavaScript applications. It provides type-safe routing, nested routes, and excellent developer experience.' },
        '2': { title: 'JSX Rendering Made Simple', body: 'Combine the power of JSX with vanilla JavaScript. The JSX renderer makes it easy to build component-based UIs without a framework.' },
        '3': { title: 'Building Modern Web Apps', body: 'Modern web applications require modern tools. Vanilla Router and JSX renderer provide a lightweight alternative to heavy frameworks.' },
      }
      if (!posts[id]) throw new Error('Post not found')
      return posts[id]
    }

    // Root component using JSX
    const RootComponent = (router) => {
      return () => {
        return jsx('div', {},
          jsx('nav', {},
            jsx('a', { href: buildHref(router, { to: '/' }) }, 'Home'),
            jsx('a', { href: buildHref(router, { to: '/posts' }) }, 'Posts')
          ),
          jsx('main', {},
            outlet()
          )
        )
      }
    }

    const rootRoute = createRootRoute({
      component: RootComponent,
    })

    // Index component
    const IndexComponent = (router) => {
      return () => {
        return jsx('div', {},
          jsx('h1', {}, 'Welcome Home!'),
          jsx('p', {}, 'This is the home page using Vanilla Router with JSX rendering.')
        )
      }
    }

    const indexRoute = createRoute({
      getParentRoute: () => rootRoute,
      path: '/',
      component: IndexComponent,
    })

    // Posts layout route
    const postsLayoutRoute = createRoute({
      getParentRoute: () => rootRoute,
      path: 'posts',
      loader: () => fetchPosts(),
      component: (router) => {
        return () => {
          const posts = postsLayoutRoute.getLoaderData(router)
          
          if (!posts) {
            return jsx('div', { className: 'loading' }, 'Loading posts...')
          }

          return jsx('div', {},
            jsx('h1', {}, 'Posts'),
            jsx('ul', { className: 'post-list' },
              ...posts.map(post => 
                jsx('li', { className: 'post-item' },
                  jsx('a', { href: buildHref(router, { to: '/posts/$postId', params: { postId: post.id } }) }, post.title)
                )
              )
            ),
            outlet()
          )
        }
      },
    })

    // Posts index
    const postsIndexRoute = createRoute({
      getParentRoute: () => postsLayoutRoute,
      path: '/',
      component: (router) => {
        return () => {
          return jsx('div', {},
            jsx('p', {}, 'Select a post to view details.')
          )
        }
      },
    })

    // Post detail route
    const postRoute = createRoute({
      getParentRoute: () => postsLayoutRoute,
      path: '$postId',
      loader: ({ params }) => fetchPost(params.postId),
      component: (router) => {
        return () => {
          const post = postRoute.getLoaderData(router)
          
          if (!post) {
            return jsx('div', { className: 'loading' }, 'Loading...')
          }

          return jsx('div', { className: 'post-detail' },
            jsx('h1', { className: 'post-title' }, post.title),
            jsx('div', { className: 'post-body' }, post.body)
          )
        }
      },
    })

    // Create router
    const routeTree = rootRoute.addChildren([
      postsLayoutRoute.addChildren([postRoute, postsIndexRoute]),
      indexRoute,
    ])

    const router = createRouter({
      routeTree,
      defaultPreload: 'intent',
    })

    // Render function using VanillaRenderer
    const renderer = new VanillaRenderer()
    const rootElement = document.getElementById('app')
    if (!rootElement) throw new Error('App element not found')

    function render() {
      if (!rootElement) return
      const state = router.state
      
      // Convert router matches to render contexts
      const contexts = state.matches.map((match) => {
        const route = router.routesById[match.routeId]
        const matchState = router.getMatch(match.id)
        
        return {
          component: route.options.component,
          errorComponent: route.options.errorComponent,
          pendingComponent: route.options.pendingComponent,
          error: matchState?.error,
          isPending: matchState?._displayPending,
          data: {
            loaderData: matchState?.loaderData,
            params: matchState?.params,
            search: matchState?.search,
            routeId: match.routeId,
          },
        }
      })

      // Render using JSX renderer with router
      const html = renderer.render(contexts, router)
      rootElement.innerHTML = html
    }

    // Setup router
    await vanillaRouter(router, render)
  </script>
</body>
</html>
